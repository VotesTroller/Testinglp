<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LocalPlaces</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>


    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif']
                    },
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                    },
                    animation: {
                        'aurora': 'aurora 20s linear infinite',
                        'fade-up': 'fadeUp 0.5s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        aurora: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' },
                        },
                        fadeUp: {
                            '0%': { opacity: 0, transform: 'translateY(20px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        },
                        scaleIn: {
                            '0%': { opacity: 0, transform: 'scale(0.95) translate(-50%, -50%)' },
                            '100%': { opacity: 1, transform: 'scale(1) translate(-50%, -50%)' }
                        }
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'glow-primary': '0 0 20px -5px rgba(99, 102, 241, 0.6)',
                        'glow-purple': '0 0 20px -5px rgba(168, 85, 247, 0.6)'
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #f8fafc; color: #1e293b; transition: background-color 0.3s ease, color 0.3s ease; -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden;
        }
        .dark body { background-color: #0b1121; color: #f1f5f9; }
        
        .aurora-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; opacity: 0.6; pointer-events: none;
            background: radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15) 0%, transparent 50%), 
                        radial-gradient(circle at 100% 0%, rgba(168, 85, 247, 0.15) 0%, transparent 50%), 
                        radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.15) 0%, transparent 50%), 
                        radial-gradient(circle at 0% 100%, rgba(236, 72, 153, 0.15) 0%, transparent 50%);
            filter: blur(100px); transform: translateZ(0); 
        }
        .dark .aurora-bg { opacity: 0.3; }


        .glass-nav { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px) saturate(180%); border-bottom: 1px solid rgba(255, 255, 255, 0.3); }
        .dark .glass-nav { background: rgba(15, 23, 42, 0.7); border-bottom: 1px solid rgba(255, 255, 255, 0.05); }


        .modern-input { 
            width: 100%; padding: 0.875rem 1.25rem; border-radius: 1rem; 
            background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0,0,0,0.05);
            color: #0f172a; transition: all 0.2s; font-size: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02); backdrop-filter: blur(4px);
        }
        .modern-input:focus { background: #fff; border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); outline: none; }
        .dark .modern-input { background: rgba(30, 41, 59, 0.8); color: #fff; border-color: rgba(255,255,255,0.05); }
        .dark .modern-input:focus { background: rgba(30, 41, 59, 1); border-color: #6366f1; }


        .place-card-container { perspective: 1000px; }
        .place-card { 
            background: rgba(255, 255, 255, 0.9); border-radius: 1.25rem; overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.5); transition: all 0.3s ease-out;
            transform-style: preserve-3d;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .dark .place-card { background: rgba(30, 41, 59, 0.8); border-color: rgba(255, 255, 255, 0.05); }


        @media (min-width: 768px) {
            .place-card:hover { 
                transform: translateY(-8px) rotateX(2deg) rotateY(-2deg); 
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), var(--tw-shadow-glow-primary);
            }
        }
        .place-card:active { transform: scale(0.98); transition: 0.1s; }


        .btn-gradient-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); }
        .btn-gradient-primary:hover { background: linear-gradient(135deg, #4f46e5, #4338ca); box-shadow: var(--tw-shadow-glow-primary); }
        
        .btn-gradient-purple { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .btn-gradient-purple:hover { background: linear-gradient(135deg, #9333ea, #7e22ce); box-shadow: var(--tw-shadow-glow-purple); }


        .btn-click-effect:active { transform: scale(0.95); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="antialiased safe-pb">
    <div class="aurora-bg"></div>


    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 glass-nav transition-all duration-300 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                
                <!-- LOGO SECTION -->
                <div class="flex items-center gap-3 cursor-pointer btn-click-effect" onclick="app.renderHome()">
                    <!-- Try to load image logo, fallback to Icon if failed/missing -->
                    <img src="logo.png" id="app-logo-img" class="h-8 w-auto hidden" onerror="this.style.display='none'; document.getElementById('app-logo-icon').classList.remove('hidden');">
                    
                    <!-- Fallback Icon Logo -->
                    <div id="app-logo-icon" class="btn-gradient-primary text-white p-2 rounded-xl shadow-lg shadow-primary-500/30 flex-shrink-0">
                        <i class="ph-bold ph-map-trifold text-xl"></i>
                    </div>
                    
                    <span class="text-lg sm:text-xl font-display font-bold tracking-tight text-slate-900 dark:text-white truncate">LocalPlaces</span>
                </div>


                <div class="flex items-center gap-2 sm:gap-3">
                    <div id="gps-status" class="hidden md:flex items-center gap-1.5 px-3 py-1 rounded-full bg-emerald-100/80 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 text-xs font-semibold backdrop-blur">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div><span>GPS Active</span>
                    </div>
                    <button onclick="app.toggleTheme()" class="p-2.5 rounded-full bg-slate-100/50 dark:bg-slate-800/50 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 transition btn-click-effect"><i id="theme-icon" class="ph-fill ph-moon text-xl"></i></button>
                    
                    <button id="auto-btn" onclick="app.openAutoDiscover()" class="hidden btn-gradient-purple text-white px-3 sm:px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 btn-click-effect relative overflow-hidden group">
                        <span class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></span>
                        <i class="ph-bold ph-magic-wand relative z-10"></i> <span class="hidden sm:inline relative z-10">Auto-Add</span>
                    </button>
                    
                    <button id="create-btn" onclick="app.openEditor()" class="hidden bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-3 sm:px-4 py-2 rounded-xl text-sm font-bold shadow-lg transition flex items-center gap-2 btn-click-effect hover:shadow-xl"><i class="ph-bold ph-plus"></i> <span class="hidden sm:inline">Add</span></button>
                    <button onclick="app.handleAdminClick()" class="p-2.5 rounded-full text-slate-400 hover:text-slate-900 dark:hover:text-white transition btn-click-effect"><i id="admin-icon" class="ph-bold ph-lock-key text-xl"></i></button>
                </div>
            </div>
        </div>
    </nav>


    <!-- Main Container -->
    <main class="pt-24 sm:pt-28 pb-12 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto min-h-screen">
        
        <!-- Hero & Search (Visible on Home) -->
        <div id="hero-section" class="max-w-3xl mx-auto text-center mb-10 sm:mb-14 animate-fade-up transition-all duration-300">
            <h1 class="text-3xl sm:text-5xl font-display font-extrabold text-slate-900 dark:text-white mb-6 tracking-tight drop-shadow-sm">Discover local<br class="sm:hidden"> hidden gems.</h1>
            
            <!-- SMART SEARCH BAR -->
            <div class="relative group z-10">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none"><i class="ph-bold ph-magnifying-glass text-slate-400 text-xl"></i></div>
                <input type="text" id="main-search" oninput="app.handleSearch(this.value)" class="w-full pl-12 pr-14 py-4 sm:py-5 rounded-2xl sm:rounded-3xl border-0 bg-white/80 dark:bg-slate-900/80 text-lg shadow-glass focus:ring-2 focus:ring-primary-500 transition-all dark:text-white backdrop-blur-md font-medium" placeholder="Try 'Temples in Pathanamthitta'...">
                
                <!-- AI Search Button -->
                <button onclick="app.triggerAISearch()" class="absolute inset-y-1.5 right-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-2.5 rounded-xl sm:rounded-2xl shadow-md hover:shadow-lg transition-all hover:scale-105 active:scale-95 group/ai" title="Smart AI Search">
                    <i class="ph-bold ph-sparkle text-xl animate-pulse"></i>
                </button>
            </div>
            
            <div class="mt-6 flex justify-center animate-fade-up stagger-delay-1 gap-3">
                <button onclick="app.suggestRandom()" class="group flex items-center gap-2 px-5 py-2.5 bg-white/70 dark:bg-slate-800/70 text-primary-600 dark:text-primary-400 font-bold rounded-full shadow-sm hover:shadow-md border border-white/50 dark:border-slate-700/50 text-sm transition-all transform hover:-translate-y-1 backdrop-blur-md btn-click-effect">
                    <i class="ph-fill ph-dice-five text-xl group-hover:rotate-180 transition-transform duration-500"></i> Surprise Me
                </button>
            </div>


            <!-- Categories -->
            <div class="flex flex-nowrap overflow-x-auto gap-3 mt-8 pb-4 sm:justify-center px-2 snap-x scroll-smooth no-scrollbar animate-fade-up stagger-delay-2">
                <button onclick="app.filter('All')" class="cat-pill active px-5 py-2 rounded-full text-sm font-bold bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-md flex-shrink-0 snap-start btn-click-effect transition-all">All</button>
                <button onclick="app.filter('Nature')" class="cat-pill px-5 py-2 rounded-full text-sm font-bold bg-white/70 border border-white/50 text-slate-600 dark:bg-slate-800/70 dark:border-slate-700/50 dark:text-slate-300 flex-shrink-0 snap-start backdrop-blur-md hover:bg-white dark:hover:bg-slate-800 transition-all btn-click-effect">Nature</button>
                <button onclick="app.filter('Historic')" class="cat-pill px-5 py-2 rounded-full text-sm font-bold bg-white/70 border border-white/50 text-slate-600 dark:bg-slate-800/70 dark:border-slate-700/50 dark:text-slate-300 flex-shrink-0 snap-start backdrop-blur-md hover:bg-white dark:hover:bg-slate-800 transition-all btn-click-effect">Historic</button>
                <button onclick="app.filter('Urban')" class="cat-pill px-5 py-2 rounded-full text-sm font-bold bg-white/70 border border-white/50 text-slate-600 dark:bg-slate-800/70 dark:border-slate-700/50 dark:text-slate-300 flex-shrink-0 snap-start backdrop-blur-md hover:bg-white dark:hover:bg-slate-800 transition-all btn-click-effect">Urban</button>
                <button onclick="app.filter('Food')" class="cat-pill px-5 py-2 rounded-full text-sm font-bold bg-white/70 border border-white/50 text-slate-600 dark:bg-slate-800/70 dark:border-slate-700/50 dark:text-slate-300 flex-shrink-0 snap-start backdrop-blur-md hover:bg-white dark:hover:bg-slate-800 transition-all btn-click-effect">Food</button>
            </div>
        </div>


        <!-- Content Area -->
        <div id="app-container" class="transition-all duration-300 min-h-[400px]">
            <div class="flex flex-col items-center justify-center py-20 animate-pulse">
                <div class="w-12 h-12 border-4 border-primary-100 dark:border-primary-900 border-t-primary-600 rounded-full animate-spin mb-4"></div>
                <p class="text-slate-500 dark:text-slate-400 font-medium">Waking up database...</p>
            </div>
        </div>
    </main>


    <footer class="border-t border-slate-200/50 dark:border-slate-800/50 py-8 text-center backdrop-blur-sm"><p class="text-slate-500 dark:text-slate-400 text-sm font-medium">© <span id="year"></span> LocalPlaces. Crafted with AI.</p></footer>


    <!-- MODALS -->


    <!-- Login -->
    <div id="login-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-md transition-opacity" onclick="app.closeLogin()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-xs bg-white/90 dark:bg-slate-900/90 p-8 rounded-3xl shadow-2xl border border-white/50 dark:border-slate-700/50 backdrop-blur-xl animate-scale-in">
            <div class="text-center mb-6">
                <h3 class="text-xl font-display font-bold dark:text-white">Admin Access</h3>
            </div>
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Username</label>
            <input type="text" id="user-input" class="modern-input font-bold mb-3" placeholder="Username">
            <label class="block text-xs font-bold text-slate-500 uppercase mb-1 ml-1">Password</label>
            <input type="password" id="pin-input" class="modern-input font-bold mb-6" placeholder="••••••••">
            <button onclick="app.submitLogin()" class="w-full btn-gradient-primary hover:shadow-glow-primary text-white font-bold py-3.5 rounded-xl transition btn-click-effect">Unlock</button>
            <p id="login-error" class="text-rose-500 text-sm text-center mt-4 hidden font-bold animate-bounce">Invalid Credentials</p>
        </div>
    </div>


    <!-- AUTO DISCOVER MODAL -->
    <div id="auto-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-md" onclick="app.closeAuto()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-lg bg-white/90 dark:bg-slate-900/90 rounded-3xl shadow-2xl border border-white/50 dark:border-slate-700/50 p-8 max-h-[90vh] overflow-y-auto backdrop-blur-xl animate-scale-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-display font-bold text-xl sm:text-2xl dark:text-white flex items-center gap-3">
                    <span class="btn-gradient-purple p-2 rounded-xl text-white"><i class="ph-fill ph-sparkle"></i></span> AI Auto-Add
                </h3>
                <button onclick="app.closeAuto()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition btn-click-effect"><i class="ph-bold ph-x text-xl dark:text-white"></i></button>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm mb-6 leading-relaxed">Enter a location query. Our AI will use Google Search to find real places with exact coordinates and generate rich details.</p>
            <div class="space-y-5">
                <input id="auto-query" class="modern-input text-lg" placeholder="e.g. Best street food in Delhi...">
                <button onclick="app.runAutoDiscover()" id="run-auto-btn" class="w-full btn-gradient-purple hover:shadow-glow-purple text-white font-bold py-4 rounded-xl shadow-lg transition flex justify-center items-center gap-3 btn-click-effect text-lg"><i class="ph-bold ph-magnifying-glass"></i> Find & Add Places</button>
                <div id="auto-logs" class="hidden bg-slate-100/80 dark:bg-slate-800/80 p-4 rounded-xl text-xs font-mono text-slate-600 dark:text-slate-300 h-32 overflow-y-auto border border-slate-200 dark:border-slate-700"></div>
            </div>
        </div>
    </div>


    <!-- EDITOR MODAL -->
    <div id="editor-modal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-md" onclick="app.closeEditor()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[95%] max-w-4xl h-[90vh] flex flex-col bg-white/95 dark:bg-slate-900/95 rounded-3xl shadow-2xl border border-white/50 dark:border-slate-700/50 backdrop-blur-xl animate-scale-in overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-white/50 dark:bg-slate-900/50">
                <h3 class="font-display font-bold text-xl dark:text-white">Edit Place</h3>
                <button onclick="app.closeEditor()" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition btn-click-effect"><i class="ph-bold ph-x text-xl dark:text-white"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll space-y-6 flex-1">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Title</label><input id="inp-title" class="modern-input font-bold"></div>
                    <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Category</label><select id="inp-category" class="modern-input cursor-pointer font-bold"><option value="Nature">Nature</option><option value="Historic">Historic</option><option value="Urban">Urban</option><option value="Religious">Religious</option><option value="Food">Food</option></select></div>
                </div>
                
                <div class="bg-primary-50/50 dark:bg-primary-900/10 p-5 rounded-2xl border border-primary-100 dark:border-primary-800/30">
                    <label class="block text-xs font-bold text-primary-700 dark:text-primary-400 uppercase mb-2 ml-1"><i class="ph-fill ph-google-logo"></i> Google Maps Link</label>
                    <input id="inp-maplink" class="modern-input text-sm mb-3 text-primary-700 dark:text-primary-300" placeholder="Paste link from address bar here..." oninput="app.extractFromLink(this.value)">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Latitude</label><input id="inp-lat" class="modern-input text-sm font-mono bg-slate-100 dark:bg-slate-800" readonly></div>
                        <div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Longitude</label><input id="inp-lng" class="modern-input text-sm font-mono bg-slate-100 dark:bg-slate-800" readonly></div>
                    </div>
                    <div class="mt-3 text-right"><button onclick="app.getGPS()" class="text-xs font-bold text-primary-600 hover:underline">Use My Location</button></div>
                </div>


                <div class="grid grid-cols-2 gap-4"><input id="inp-state" class="modern-input text-sm" placeholder="State"><input id="inp-district" class="modern-input text-sm" placeholder="District"><input id="inp-city" class="modern-input text-sm" placeholder="City"><input id="inp-location" class="modern-input text-sm" placeholder="Specific Location"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Image URL</label><input id="inp-image" class="modern-input" placeholder="https://..."></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Short Description</label><textarea id="inp-desc" rows="2" class="modern-input resize-none"></textarea></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Full Content (Markdown)</label><textarea id="inp-content" rows="8" class="modern-input font-mono text-sm leading-relaxed"></textarea></div>
                <input type="hidden" id="inp-keywords">
            </div>
            <div class="p-5 border-t border-slate-100/50 dark:border-slate-800/50 flex justify-end gap-4 safe-pb bg-white/50 dark:bg-slate-900/50">
                <button onclick="app.closeEditor()" class="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition btn-click-effect">Cancel</button>
                <button onclick="app.save()" class="px-8 py-3 rounded-xl font-bold btn-gradient-primary text-white shadow-lg hover:shadow-glow-primary transition btn-click-effect">Save Place</button>
            </div>
        </div>
    </div>


    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        const firebaseConfig = {
          apiKey: "AIzaSyDlVnYqJTvVXlrpD6vyNqmLQYiAzoB_J8M",
          authDomain: "localplace-c0b18.firebaseapp.com",
          projectId: "localplace-c0b18",
          storageBucket: "localplace-c0b18.firebasestorage.app",
          messagingSenderId: "631086890668",
          appId: "1:631086890668:web:884b6a0f2b74fdf980a909"
        };


        const apiKey = ""; // Gemini API Key


        const fb = initializeApp(firebaseConfig);
        const db = getFirestore(fb);
        const auth = getAuth(fb);


        const app = {
            data: [], userPos: null, admin: false, adminUser: 'admin@lp', adminPin: 'Bz8@localplaces', cat: 'All', ref: null, synth: window.speechSynthesis, speaking: false,
            
            init() {
                // Load logo logic
                const img = document.getElementById('app-logo-img');
                const icon = document.getElementById('app-logo-icon');
                img.onload = () => { img.classList.remove('hidden'); icon.classList.add('hidden'); };
                
                this.loadTheme();
                const urlParams = new URLSearchParams(window.location.search);
                this.auth(urlParams.get('place')); 
                this.gps();
                document.getElementById('year').textContent = new Date().getFullYear();
                
                window.onpopstate = () => {
                    const pid = new URLSearchParams(window.location.search).get('place');
                    pid ? this.renderDetail(pid, false) : this.renderHome(false);
                };
            },


            async auth(initialPlaceId) {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, u => {
                    if(u) {
                        this.ref = collection(db, 'localPlaces'); 
                        onSnapshot(this.ref, s => {
                            this.data = s.docs.map(d => ({id: d.id, ...d.data()}));
                            initialPlaceId ? this.renderDetail(initialPlaceId, false) : this.render();
                        }, e => {
                            console.error("DB Error:", e);
                            document.getElementById('app-container').innerHTML = `<div class="text-center py-20 animate-fade-up"><div class="inline-flex p-4 bg-rose-100 text-rose-500 rounded-full mb-4"><i class="ph-fill ph-warning text-3xl"></i></div><p class="text-slate-800 dark:text-white font-bold text-lg mb-2">Connection Failed</p><p class="text-sm text-slate-500">Check Database Rules.</p></div>`;
                        });
                    }
                });
            },


            // --- AI SEMANTIC SEARCH ---
            async triggerAISearch() {
                const query = document.getElementById('main-search').value;
                if(!query) return alert("Please type a search query first.");
                
                const container = document.getElementById('app-container');
                container.innerHTML = `<div class="flex flex-col items-center py-20 animate-pulse"><div class="text-4xl mb-4">✨</div><p class="text-slate-500 font-bold">AI is filtering places...</p></div>`;


                const locations = [...new Set(this.data.map(i => `${i.city}, ${i.district}, ${i.state}`))].join(" | ");
                
                const prompt = `User Query: "${query}". Available Locations: ${locations}.
                Task: Identify 'Target Location' (e.g. 'Pathanamthitta'), 'Target Category' (Nature|Historic|Urban|Religious|Food).
                Return JSON: { "target_location": "string|null", "target_category": "string|null", "keywords": ["k1"] }`;


                try {
                    const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                    });
                    const res = await req.json();
                    const txt = res.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
                    const filter = JSON.parse(txt);
                    this.applySmartFilter(filter, query);
                } catch(e) {
                    console.error(e);
                    this.render(query.toLowerCase());
                }
            },


            applySmartFilter(filter, originalQuery) {
                let hits = this.data.filter(item => {
                    let locationMatch = true;
                    let categoryMatch = true;
                    
                    if (filter.target_location) {
                        const locTerm = filter.target_location.toLowerCase();
                        const placeLoc = (item.city + " " + item.district + " " + item.state + " " + item.location + " " + item.title + " " + item.desc).toLowerCase();
                        locationMatch = placeLoc.includes(locTerm);
                    }
                    if (filter.target_category) {
                        categoryMatch = item.category === filter.target_category;
                    }
                    return locationMatch && categoryMatch;
                });


                if (hits.length === 0) hits = this.data.filter(i => (i.title+i.desc+i.city).toLowerCase().includes(originalQuery.toLowerCase()));
                
                if (hits.length === 0) {
                    document.getElementById('app-container').innerHTML = `<div class="text-center py-20 text-slate-400"><p>No matches found for "${originalQuery}".</p></div>`;
                } else {
                    this.renderList(hits);
                }
            },


            // --- CORE ---
            suggestRandom() {
                if(this.data.length === 0) return alert("No places found! Add some first.");
                const randomIndex = Math.floor(Math.random() * this.data.length);
                this.renderDetail(this.data[randomIndex].id);
            },


            openAutoDiscover() { document.getElementById('auto-modal').classList.remove('hidden'); },
            closeAuto() { document.getElementById('auto-modal').classList.add('hidden'); },
            async runAutoDiscover() {
                const query = document.getElementById('auto-query').value;
                if(!query) return alert("Enter location!");
                const btn = document.getElementById('run-auto-btn'), logs = document.getElementById('auto-logs');
                btn.innerHTML = `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Scanning...`;
                logs.classList.remove('hidden'); logs.innerHTML = `> Searching: "${query}"...`;


                const prompt = `Use Google Search to find 3 REAL places matching: "${query}". Find EXACT Latitude/Longitude. Return ONLY JSON Array: [{ title, lat, lng, state, district, city, location, category, desc, content, keywords }]`;


                try {
                    const req = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({contents:[{parts:[{text:prompt}]}], tools:[{google_search:{}}]})
                    });
                    const res = await req.json();
                    const txt = res.candidates[0].content.parts[0].text.replace(/```json|```/g,'').trim();
                    const places = JSON.parse(txt);
                    
                    logs.innerHTML += `\n> Found ${places.length} places. Saving...`;
                    for (const p of places) {
                        const img = `https://source.unsplash.com/800x600/?${encodeURIComponent(p.title + ',' + p.category)}`;
                        await addDoc(this.ref, { ...p, image: img, createdAt: Date.now() });
                    }
                    logs.innerHTML += `\n> DONE!`; setTimeout(() => { this.closeAuto(); this.render(); }, 1500);
                } catch(e) { logs.innerHTML += `\n> ERROR: ${e.message}`; } finally { btn.innerHTML = "Find & Add"; }
            },


            loadTheme() {
                if(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
                this.updTheme();
            },
            toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; this.updTheme(); },
            updTheme() { document.getElementById('theme-icon').className = document.documentElement.classList.contains('dark') ? 'ph-fill ph-sun text-xl' : 'ph-fill ph-moon text-xl'; },
            
            gps() { navigator.geolocation.getCurrentPosition(p => { this.userPos = { lat: p.coords.latitude, lng: p.coords.longitude }; document.getElementById('gps-status').classList.remove('hidden'); document.getElementById('gps-status').classList.add('flex'); this.render(); }); },
            dist(lat1, lon1, lat2, lon2) { if(!lat1||!lon2)return null; const R=6371, dLat=(lat2-lat1)*(Math.PI/180), dLon=(lon2-lon1)*(Math.PI/180), a = Math.sin(dLat/2)**2 + Math.cos(lat1*(Math.PI/180))*Math.cos(lat2*(Math.PI/180))*Math.sin(dLon/2)**2; return (R*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))).toFixed(1); },
            
            toggleAudio(id) {
                const i = this.data.find(d=>d.id===id);
                if(this.speaking) { this.synth.cancel(); this.speaking=false; this.updAudBtn(id,false); return; }
                const ut = new SpeechSynthesisUtterance(`${i.title}. ${i.desc}. ${i.content}`.replace(/[#*]/g,''));
                ut.onend = () => { this.speaking=false; this.updAudBtn(id,false); };
                this.synth.speak(ut); this.speaking=true; this.updAudBtn(id,true);
            },
            updAudBtn(id, play) {
                const b = document.getElementById('audio-btn'); if(!b) return;
                b.innerHTML = play ? `<div class="flex items-end gap-1 h-3 playing"><div class="bar"></div><div class="bar"></div><div class="bar"></div></div> Stop` : `<i class="ph-fill ph-speaker-high"></i> Listen`;
                b.classList.toggle('btn-gradient-primary', play); b.classList.toggle('text-white', play);
                b.classList.toggle('bg-slate-100', !play); b.classList.toggle('dark:bg-slate-800', !play);
            },


            handleAdminClick() { this.admin ? (this.admin=false, this.renderUI(), alert("Locked")) : (document.getElementById('login-modal').classList.remove('hidden'), document.getElementById('user-input').focus()); },
            closeLogin() { document.getElementById('login-modal').classList.add('hidden'); },
            submitLogin() { if(document.getElementById('user-input').value === this.adminUser && document.getElementById('pin-input').value === this.adminPin) { this.admin=true; this.closeLogin(); this.renderUI(); } else document.getElementById('login-error').classList.remove('hidden'); },
            renderUI() {
                const s = this.admin ? 'remove' : 'add';
                document.getElementById('create-btn').classList[s]('hidden'); document.getElementById('auto-btn').classList[s]('hidden');
                document.getElementById('admin-icon').className = this.admin ? 'ph-fill ph-lock-open text-primary-600 text-xl' : 'ph-bold ph-lock-key text-xl';
                document.querySelectorAll('.admin-ui').forEach(e => e.classList[s]('hidden'));
            },


            openEditor(id=null) { document.getElementById('editor-modal').classList.remove('hidden'); document.getElementById('edit-id').value = ''; ['title','image','state','district','city','location','desc','content','lat','lng','keywords','maplink'].forEach(k=>document.getElementById('inp-'+k).value=''); if(id) { const d = this.data.find(i=>i.id===id); document.getElementById('edit-id').value=id; for(let k in d) { const el=document.getElementById('inp-'+k); if(el) el.value=d[k]; } } },
            closeEditor() { document.getElementById('editor-modal').classList.add('hidden'); },
            extractFromLink(url) { let m = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/) || url.match(/q=(-?\d+\.\d+),(-?\d+\.\d+)/); if(m) { document.getElementById('inp-lat').value=m[1]; document.getElementById('inp-lng').value=m[2]; } },
            getGPS() { navigator.geolocation.getCurrentPosition(p=>{ document.getElementById('inp-lat').value=p.coords.latitude.toFixed(6); document.getElementById('inp-lng').value=p.coords.longitude.toFixed(6); }); },
            async save() {
                const id = document.getElementById('edit-id').value; const d = { createdAt: Date.now() };
                ['title','category','image','state','district','city','location','desc','content','lat','lng','keywords'].forEach(k=>d[k]=document.getElementById('inp-'+k).value);
                if(!d.title) return alert("Title required");
                try { id ? await updateDoc(doc(this.ref,id),d) : await addDoc(this.ref,d); this.closeEditor(); } catch(e){ alert(e.message); }
            },
            async del(id) { if(confirm("Delete?")) { await deleteDoc(doc(this.ref,id)); this.renderDetail(null); this.render(); } },
            filter(c) { 
                this.cat = c; 
                document.querySelectorAll('.cat-pill').forEach(b => {
                    const active = 'active px-5 py-2 rounded-full text-sm font-bold bg-slate-900 text-white dark:bg-white dark:text-slate-900 shadow-md flex-shrink-0 snap-start btn-click-effect transition-all';
                    const inactive = 'px-5 py-2 rounded-full text-sm font-bold bg-white/70 border border-white/50 text-slate-600 dark:bg-slate-800/70 dark:border-slate-700/50 dark:text-slate-300 flex-shrink-0 snap-start backdrop-blur-md hover:bg-white dark:hover:bg-slate-800 transition-all btn-click-effect';
                    b.className = b.innerText === c ? `cat-pill ${active}` : `cat-pill ${inactive}`;
                });
                this.render(); 
            },
            handleSearch(v) { this.render(v.toLowerCase()); },


            // Rendering Logic
            renderHome(updateUrl = true) {
                if(updateUrl) { const url = new URL(window.location); url.searchParams.delete('place'); window.history.pushState({}, '', url); }
                document.getElementById('hero-section').classList.remove('hidden');
                this.render();
            },


            render(search='') {
                if(!search) {
                    const list = this.data.filter(i => this.cat==='All' || i.category===this.cat);
                    this.renderList(list);
                }
            },


            renderList(list) {
                const con = document.getElementById('app-container');
                if(this.userPos) { list.forEach(i => i._dist = this.dist(this.userPos.lat, this.userPos.lng, i.lat, i.lng)); list.sort((a,b) => (parseFloat(a._dist)||9999) - (parseFloat(b._dist)||9999)); }
                
                if(list.length === 0) return con.innerHTML = `<div class="text-center py-20 text-slate-400 animate-fade-up"><i class="ph-duotone ph-magnifying-glass text-5xl mb-4 text-slate-300"></i><p class="font-medium">No places found.</p></div>`;
                
                con.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 place-card-container">${list.map((i, idx) => `
                    <div class="place-card group cursor-pointer animate-fade-up" style="animation-delay: ${idx * 0.1}s" onclick="app.renderDetail('${i.id}')">
                        <div class="h-48 sm:h-56 relative overflow-hidden">
                            <img src="${i.image}" class="w-full h-full object-cover group-hover:scale-110 transition duration-700" loading="lazy" onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="absolute top-3 right-3"><span class="bg-white/90 dark:bg-black/80 backdrop-blur-md text-xs font-extrabold px-3 py-1.5 rounded-full shadow-sm">${i.category}</span></div>
                            ${i._dist ? `<div class="absolute bottom-3 left-3 bg-primary-600/90 backdrop-blur-md text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg flex items-center gap-1"><i class="ph-bold ph-navigation-arrow"></i> ${i._dist} km</div>` : ''}
                        </div>
                        <div class="p-5">
                            <h3 class="text-xl font-display font-bold text-slate-900 dark:text-white mb-1 leading-tight group-hover:text-primary-600 dark:group-hover:text-primary-400 transition truncate">${i.title}</h3>
                            <div class="flex items-center gap-1 text-sm text-slate-500 dark:text-slate-400 mb-3 font-medium"><i class="ph-fill ph-map-pin text-primary-500"></i> ${i.city || 'Unknown'}</div>
                            <p class="text-sm text-slate-600 dark:text-slate-300 line-clamp-2 leading-relaxed">${i.desc}</p>
                        </div>
                    </div>`).join('')}</div>`;
            },


            renderDetail(id, updateUrl = true) {
                // FIXED ID MATCHING (String/Number safety)
                const i = this.data.find(d => String(d.id) === String(id)); 
                
                if(!i) {
                    console.error("Place ID not found in data:", id);
                    return; // Fail gracefully or show error in container
                }
                
                if(updateUrl) {
                    const url = new URL(window.location);
                    url.searchParams.set('place', id);
                    window.history.pushState({}, '', url);
                }


                document.getElementById('hero-section').classList.add('hidden');


                const dist = this.userPos ? this.dist(this.userPos.lat, this.userPos.lng, i.lat, i.lng) : null;
                const mapUrl = (this.userPos && i.lat) ? `https://www.google.com/maps/dir/?api=1&origin=${this.userPos.lat},${this.userPos.lng}&destination=${i.lat},${i.lng}&travelmode=driving` : `https://www.google.com/maps/search/?api=1&query=${i.lat},${i.lng}`;


                document.getElementById('app-container').innerHTML = `
                <div class="animate-fade-up">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="app.renderHome()" class="px-4 py-2.5 rounded-full bg-white/70 dark:bg-slate-800/70 border border-white/50 dark:border-slate-700/50 hover:bg-white dark:hover:bg-slate-800 flex items-center gap-2 text-sm font-bold text-slate-700 dark:text-slate-300 transition backdrop-blur-md btn-click-effect"><i class="ph-bold ph-arrow-left"></i> Back</button>
                        <div class="flex gap-3">
                             <button id="audio-btn" onclick="app.toggleAudio('${i.id}')" class="px-4 py-2.5 rounded-full bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-900 dark:text-white font-bold text-sm flex items-center gap-2 transition btn-click-effect"><i class="ph-fill ph-speaker-high"></i> <span class="hidden sm:inline">Listen</span></button>
                             <a href="${mapUrl}" target="_blank" class="px-5 py-2.5 rounded-full btn-gradient-primary text-white font-bold text-sm flex items-center gap-2 shadow-lg hover:shadow-glow-primary transition btn-click-effect"><i class="ph-bold ph-navigation-arrow"></i> ${dist?`Go (${dist}km)`:'Navigate'}</a>
                        </div>
                    </div>
                    <div class="relative h-[300px] sm:h-[450px] w-full rounded-[2rem] overflow-hidden shadow-2xl mb-10 group">
                        <img src="${i.image}" class="w-full h-full object-cover scale-105 group-hover:scale-100 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-8 sm:p-10 w-full">
                            <span class="inline-block bg-white/20 backdrop-blur-md text-white text-xs font-extrabold px-3 py-1.5 rounded-full mb-3 border border-white/10">${i.category}</span>
                            <h1 class="text-4xl sm:text-6xl font-display font-extrabold text-white mb-2 leading-tight drop-shadow-lg">${i.title}</h1>
                            <div class="flex items-center gap-2 text-slate-200 font-medium text-lg"><i class="ph-fill ph-map-pin text-primary-400"></i> ${i.location || i.city}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 sm:gap-6 mb-12">
                        ${this.detailCard('ph-duotone ph-map-trifold text-purple-500', 'State', i.state)}
                        ${this.detailCard('ph-duotone ph-buildings text-blue-500', 'District', i.district)}
                        ${this.detailCard('ph-duotone ph-city text-emerald-500', 'City', i.city)}
                        ${this.detailCard('ph-duotone ph-push-pin text-rose-500', 'Location', i.location)}
                    </div>


                    <div class="admin-ui ${this.admin?'':'hidden'} mb-10 flex gap-4 p-5 rounded-2xl bg-slate-50/50 dark:bg-slate-900/50 border-2 border-dashed border-slate-300 dark:border-slate-700 backdrop-blur-sm">
                        <button onclick="app.openEditor('${i.id}')" class="flex-1 py-3 font-bold text-slate-600 dark:text-slate-300 hover:text-primary-600 dark:hover:text-primary-400 flex justify-center items-center gap-2 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition btn-click-effect"><i class="ph-bold ph-pencil-simple"></i> Edit Place</button>
                        <div class="w-px bg-slate-300 dark:bg-slate-600"></div>
                        <button onclick="app.del('${i.id}')" class="flex-1 py-3 font-bold text-rose-500 hover:text-rose-600 flex justify-center items-center gap-2 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition btn-click-effect"><i class="ph-bold ph-trash"></i> Delete Place</button>
                    </div>
                    <article class="prose dark:prose-invert lg:prose-xl max-w-none text-slate-700 dark:text-slate-300 font-sans leading-relaxed">${marked.parse(i.content||'')}</article>
                </div>`;
                window.scrollTo(0,0);
            },


            detailCard(icon, label, value) {
                return `<div class="bg-white/60 dark:bg-slate-800/60 p-5 rounded-2xl flex flex-col items-center justify-center text-center shadow-glass border border-white/50 dark:border-slate-700/50 backdrop-blur-md group hover:translate-y-[-4px] transition-all">
                    <i class="${icon} text-3xl mb-3 group-hover:scale-110 transition-transform"></i>
                    <div class="text-[11px] font-extrabold text-slate-400 uppercase tracking-wider mb-1">${label}</div>
                    <div class="font-bold text-slate-900 dark:text-white truncate w-full text-sm sm:text-base">${value||'-'}</div>
                </div>`;
            }
        };


        window.app = app;
        app.init();
        document.getElementById('pin-input').addEventListener('keypress', e => { if(e.key === 'Enter') app.submitLogin(); });
    </script>
</body>
</html>